<html>
    <head>
        <meta charset="utf-8" />
        <script type="importmap">
            {
                "imports": {
                  "three": "https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.module.js",
                  "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
                }
              }
        </script>
        <script type="module">
            import * as THREE from "three";
            import { OrbitControls } from "three/addons/controls/OrbitControls.js";

            var SettingElements;
            var scene;
            var camera;
            var renderer;
            SettingElements = Setting(scene);
            scene = SettingElements[0];
            camera = SettingElements[1];
            renderer = SettingElements[2];

            //マテリアル設定
            const material = new THREE.MeshBasicMaterial({wireframe:true});
            const linemat = new THREE.LineBasicMaterial({color:0xffffff});


            //各種パラメータ設定

            var PlanetNameIndexs = [
                "Sol","Mercury","Venus","Earth","Moon","Mars"
            ];
            var planetsMeshize = 1,
                frame = 0,
                targetNumber = 0,
                stop = false,
                PointsCount = 0,
                PointsCountValue = 1,
                simT = 1,
                time = 0,
                dt = 1,//(60*60*24)
                G = 6.67428 * Math.pow(10,-11)/1000,//m kg s

                OrbitPoints = [];
                for(let i=0; i<PlanetNameIndexs.length; i++){
                    OrbitPoints.push([]);
                };


            document.getElementById("bysok").value = simT;
            document.getElementById("size").value = planetsMeshize;
            document.getElementById("target").value = 0;
            document.getElementById("Point").value = PointsCountValue;

            //a:軌道長半径、e:離心率、i:傾斜角、node:昇交点経度(黄経)、peri:近点引数(傾斜角引数)、m:質量、r:半径、mu:日日平均運動、den:密度、acc:平均軌道速度 km/day/km^3/
            //天体情報
            var OrbitalBodys ={
                Sol:{
                    type:"planet",
                    a:0,
                    m:1.99*1e+30 / 1000/1000/1000,
                    r:695510 / 1000,
                    den:1411,//kg/m^3
                    acc:0,
                    i:0
                },
                Mercury:{
                    type:"planet",
                    a:5.791*1e+7 / 1000,
                    e:0.205,
                    i:7.00,
                    node:48.33,
                    peri:77.45,
                    m:3.301*1e+23 / 1000/1000/1000,
                    r:2439.5 / 1000,
                    mu:rad(360/87.97),
                    den:5427,
                    acc:47.36
                },
                Venus:{
                    type:"planet",
                    a:1.082*1e+8/ 1000,
                    e:0.0067,
                    i:3.39,
                    node:76.68,
                    peri:131.5,
                    m:4.86*1e+24 /1000/1000/1000,
                    r:6051.8 / 1000,
                    mu:rad(360/224.701),
                    den:5243,
                    acc:35.02
                },
                Earth:{
                    type:"planet",
                    acc:29.78,
                    a:1.495*1e+8 / 1000,
                    e:0.0167,
                    i:0.002,
                    m:5.972*1e+24 / 1000/1000/1000,
                    r:6378.1 / 1000,
                    mu:rad(360/365.24),
                    den:551,
                },
                Moon:{
                    type:"satellite",
                    p:"Earth",
                    a:3.84*1e+5 / 1000,
                    e:0.054,
                    i:5.514,
                    m:7.347*1e+22 / 1000/1000/1000,
                    r:1737.15 / 1000,
                    mu:rad(360/27.31),
                    den:3344,
                    acc:1.02
                },
                Mars:{
                    type:"planet",
                    acc:24.07,
                    a:2.27*1e+8 / 1000,
                    e:0.093,
                    i:1.85,
                    m:6.41*1e+23 /1000/1000/1000,
                    r:3397.2 / 1000,
                }

            };

            //位置ベクトル情報
            var PosVector3 = [];
            for(let i=0; i<PlanetNameIndexs.length; i++){
                if(OrbitalBodys[PlanetNameIndexs[i]].type == "planet"){
                    PosVector3.push(new THREE.Vector3(0,0,OrbitalBodys[PlanetNameIndexs[i]].a));
                }
                if(OrbitalBodys[PlanetNameIndexs[i]].type == "satellite"){
                    PosVector3.push(new THREE.Vector3(
                        0,0,
                        OrbitalBodys[PlanetNameIndexs[i]].a + OrbitalBodys[OrbitalBodys[PlanetNameIndexs[i]].p].a
                    ));
                }
            };
            

            //初期速度設定
            var Velocity = [];
            for(let i=0; i<PlanetNameIndexs.length; i++){
                if(OrbitalBodys[PlanetNameIndexs[i]].type == "planet"){
                    Velocity.push(new THREE.Vector3(OrbitalBodys[PlanetNameIndexs[i]].acc ,0,0));
                }
                if(OrbitalBodys[PlanetNameIndexs[i]].type == "satellite"){
                    Velocity.push(new THREE.Vector3(
                        OrbitalBodys[PlanetNameIndexs[i]].acc + OrbitalBodys[OrbitalBodys[PlanetNameIndexs[i]].p].acc,
                        0,0
                    ));
                }
            };

            

            //惑星設定
            var PlanetObj = {
                geometry:{},
                mesh:{}
            }
            var OrbitObj = {
                geometry:{},
                mesh:{}
            }
            
            for(let i=0; i<PlanetNameIndexs.length; i++){
                PlanetObj.geometry[PlanetNameIndexs[i]] = new THREE.SphereGeometry(OrbitalBodys[PlanetNameIndexs[i]].r ,16,8);
                PlanetObj.mesh[PlanetNameIndexs[i]] = new THREE.Mesh(PlanetObj.geometry[PlanetNameIndexs[i]], material);
                PlanetObj.mesh[PlanetNameIndexs[i]].position.set(PosVector3[i].x, PosVector3[i].y, PosVector3[i].z);

                OrbitObj.geometry[PlanetNameIndexs[i]] = new THREE.BufferGeometry().setFromPoints(OrbitPoints[i]);
                OrbitObj.mesh[PlanetNameIndexs[i]] = new THREE.Line(OrbitObj.geometry[PlanetNameIndexs[i]],linemat);
                OrbitObj.mesh[PlanetNameIndexs[i]].frustumCulled = false;
            }
            

            ObjectAttach(scene);

            tick();

            //ラジアン関数
                function rad(a){
                const b = a*Math.PI/180;
                return b;
            };

            //質量計算
            function mass(r,den){
                const a = (4 / 3) * (r**3) * Math.PI ;
                const b = a * den;
                return b;
            }

            //位置、サイズアップデート

            function PosUpdatePlaet(){
                for(let i=0; i<PlanetNameIndexs.length; i++){
                    PlanetObj.mesh[PlanetNameIndexs[i]].position.set(PosVector3[i].x, PosVector3[i].y, PosVector3[i].z);
                    PlanetObj.mesh[PlanetNameIndexs[i]].scale.set(planetsMeshize,planetsMeshize,planetsMeshize);
                }
            }


            //軌道計算&描画（多体対応・リープフロッグ法）
            function orbital() {
                // 1. 速度を半ステップ進める
                let accs = [];
                for(let i=0; i<PlanetNameIndexs.length; i++){
                    let acc = new THREE.Vector3(0,0,0);
                    for(let j=0; j<PlanetNameIndexs.length; j++){
                        if(i === j) continue;
                        let r_vec = new THREE.Vector3().subVectors(PosVector3[j], PosVector3[i]);
                        let dist = r_vec.length();
                        if(dist === 0) continue;
                        let force = G * OrbitalBodys[PlanetNameIndexs[j]].m / (dist * dist * dist);
                        acc.add(r_vec.clone().multiplyScalar(force));
                    }
                    accs[i] = acc;
                }
                for(let i=0; i<PlanetNameIndexs.length; i++){
                    Velocity[i].add(accs[i].clone().multiplyScalar(dt/2));
                }

                // 2. 位置をフルステップ進める
                for(let i=0; i<PlanetNameIndexs.length; i++){
                    PosVector3[i].add(Velocity[i].clone().multiplyScalar(dt));
                }

                // 3. 新しい加速度を計算
                let accs_new = [];
                for(let i=0; i<PlanetNameIndexs.length; i++){
                    let acc = new THREE.Vector3(0,0,0);
                    for(let j=0; j<PlanetNameIndexs.length; j++){
                        if(i === j) continue;
                        let r_vec = new THREE.Vector3().subVectors(PosVector3[j], PosVector3[i]);
                        let dist = r_vec.length();
                        if(dist === 0) continue;
                        let force = G * OrbitalBodys[PlanetNameIndexs[j]].m / (dist * dist * dist);
                        acc.add(r_vec.clone().multiplyScalar(force));
                    }
                    accs_new[i] = acc;
                }

                // 4. 速度をもう半ステップ進める
                for(let i=0; i<PlanetNameIndexs.length; i++){
                    Velocity[i].add(accs_new[i].clone().multiplyScalar(dt/2));
                }

                PosUpdatePlaet();

                if (PointsCount == PointsCountValue){

                    for(let i=0; i<PlanetNameIndexs.length; i++){
                        OrbitPoints[i].push(PosVector3[i].clone());
                    }

                    PointsCount = 0;
                }

                PointsCount++;
                
            }


            //フレームレンダリング
            var raycaster = new THREE.Raycaster();
            var mouse = new THREE.Vector2();
            var mousedown = false;
            var lastMouse = {x:0, y:0};
            var cameraAzimuth = 0;
            var cameraElevation = 0;
            var cameraZoom = 100000;
            var ZoomValue = 50;

            function tick(){
                requestAnimationFrame(tick);
                frame++;

                //UI取得
                document.getElementById("year").innerText = Math.trunc(time/200);
                simT = Number(document.getElementById("bysok").value);
                planetsMeshize = Number(document.getElementById("size").value);
                targetNumber = Number(document.getElementById("target").value);
                PointsCountValue = Number(document.getElementById("Point").value);
                document.getElementById("value").innerText = ZoomValue;
                document.getElementById("value2").innerText = cameraZoom;
                stop = document.getElementById("toggle").checked;

                if (!stop) {
                    for (let j=0;j<simT;j++){
                        orbital();
                        time++;
                    }
                    for(let i=0; i<PlanetNameIndexs.length; i++){
                        if(OrbitPoints[i] < 500){OrbitPoints[i].splice(0,4);}
                    }

                    for(let i=0; i<PlanetNameIndexs.length; i++){
                        OrbitObj.geometry[PlanetNameIndexs[i]].setFromPoints(OrbitPoints[i]);
                    }
                }

                updateCameraPosition(cameraZoom, cameraAzimuth, cameraElevation);

                renderer.render(scene,camera);
            } 

            //ウィンドウリサイズ
            window.addEventListener("resize",function() {
                SettingElements = Setting(scene);
                scene = SettingElements[0];
                camera = SettingElements[1];
                renderer = SettingElements[2];
                
                ObjectAttach(scene);
            });

            //オブジェクト配置
            function ObjectAttach(scene){
                for(let i=0; i<PlanetNameIndexs.length; i++){
                    scene.attach(PlanetObj.mesh[PlanetNameIndexs[i]]);
                    scene.attach(OrbitObj.mesh[PlanetNameIndexs[i]]);
                }
            }

            document.querySelector("#myCanvas").addEventListener("mousedown", onDocumentMouseDown, false);
            document.querySelector("#myCanvas").addEventListener("mousemove", onDocumentMouseMove, false);
            document.querySelector("#myCanvas").addEventListener("mouseup", onDocumentMouseUp, false);
            document.querySelector("#myCanvas").addEventListener("wheel", onDocumentWheel, false);

            function onDocumentWheel(event){

                cameraZoom += event.deltaY*ZoomValue;
                if(cameraZoom <= 2){
                    cameraZoom = 2;
                    ZoomValue = 0.02;
                }else if(cameraZoom<=1000 && cameraZoom>2){
                    ZoomValue = 0.1;
                }else if(cameraZoom>500 && cameraZoom<2000){
                    ZoomValue = 10;
                }else if(cameraZoom>2000 && cameraZoom<25000){
                    ZoomValue = 50;
                };
            }
            function onDocumentMouseDown(event){
                event.preventDefault();
                mousedown = true;
                lastMouse.x = event.clientX;
                lastMouse.y = event.clientY;
            }
            function onDocumentMouseMove(event){
                if(!mousedown) return;
                // ドラッグ量
                var deltaX = event.clientX - lastMouse.x;
                var deltaY = event.clientY - lastMouse.y;
                // 感度調整（値は好みで調整）
                cameraAzimuth += deltaX * 0.005;
                cameraElevation -= deltaY * 0.005;
                lastMouse.x = event.clientX;
                lastMouse.y = event.clientY;
            }
            function onDocumentMouseUp(event){
                mousedown = false;
            }


            // 初期カメラ位置
            function updateCameraPosition(cameraRadius, cameraAzimuth, cameraElevation) {
                //現在の角度を足す
                
                // 仰角の範囲制限（-89度〜89度）
                cameraElevation = Math.max(-Math.PI/2 + 0.01, Math.min(Math.PI/2 - 0.01, cameraElevation));
                // 球面座標から直交座標へ変換
                camera.position.x = PlanetObj.mesh[PlanetNameIndexs[targetNumber]].position.x + cameraRadius * Math.cos(cameraElevation) * Math.sin(cameraAzimuth);
                camera.position.y = PlanetObj.mesh[PlanetNameIndexs[targetNumber]].position.y + cameraRadius * Math.sin(cameraElevation);
                camera.position.z = PlanetObj.mesh[PlanetNameIndexs[targetNumber]].position.z + cameraRadius * Math.cos(cameraElevation) * Math.cos(cameraAzimuth);
                camera.lookAt(PlanetObj.mesh[PlanetNameIndexs[targetNumber]].position);
            }

            function Setting(scene){
                //サイズを指定
                var width = window.innerWidth;
                var height = window.innerHeight;

                //レンダラーを作成
                const canvasElement = document.querySelector("#myCanvas")
                const renderer = new THREE.WebGLRenderer({
                    canvas: document.querySelector("#myCanvas"),
                });
                renderer.setPixelRatio(window.devicePixelratio);
                renderer.setSize(width,height);

                //シーンを作成
                scene = new THREE.Scene();

                //カメラを作成
                const camera = new THREE.PerspectiveCamera(60,width/height,0.1,Math.pow(10,100));
                camera.position.set(0,0,100000);

                //座標軸
                var axes = new THREE.AxesHelper(5000);
                scene.add(axes);

                return [scene,camera,renderer];
            }
        </script>
    </head>
    <body>
        <canvas id="myCanvas"></canvas>

        <div class="uis">
            <span id="year">0</span> <span> : days</span><br>
            <input type="number" id="bysok" name="tentacles" min="1" max="300" />
            <input type="number" id="size" name="tentacles" min="1" max="300" /> <br>
            <input type="number" id="target" name="tentacles" min="0" max="10" />
            <input type="number" id="Point" name="tentacles" min="1" max="300" /> <br>
            <span id="value"></span> <br>
            <span id="value2"></span> <br>
            stop :
            <input id="toggle" type='checkbox' />
        </div>

        <style>
            #myCanvas{
                width: 80%;
                height: 80%;
            }
            .uis{
                color: white;
                position: abSolute;
                top: 20;
                left: 30;
            }
        </style>
    </body>
</html>